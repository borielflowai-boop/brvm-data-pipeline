name: Create Supabase Table (run once)

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Install psycopg2
        run: pip install psycopg2-binary

      - name: Create table
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          python3 << 'PYEOF'
          import psycopg2, os, sys, socket

          password = os.environ["DB_PASSWORD"]
          ref = "lfftggyzaesvgszdycbi"

          # Try every known Supabase connection method
          configs = [
            # Project built-in PgBouncer (old-style, same host different port)
            {"host": f"{ref}.supabase.co",     "port": 6543, "user": "postgres"},
            {"host": f"{ref}.supabase.co",     "port": 5432, "user": "postgres"},
            # Transaction pooler with project host
            {"host": f"db.{ref}.supabase.co",  "port": 6543, "user": "postgres"},
          ]

          # Also try resolving with both AF_INET and AF_UNSPEC
          for hostname in [f"db.{ref}.supabase.co", f"{ref}.supabase.co"]:
              for family in [socket.AF_UNSPEC, socket.AF_INET6]:
                  try:
                      results = socket.getaddrinfo(hostname, 5432, family, socket.SOCK_STREAM)
                      for r in results[:1]:
                          ip = r[4][0]
                          af = "IPv6" if r[0] == socket.AF_INET6 else "IPv4"
                          print(f"  {hostname} → {af}: {ip}")
                          configs.insert(0, {"host": ip, "port": 5432, "user": "postgres"})
                  except:
                      pass

          SQL = """
          CREATE TABLE IF NOT EXISTS brvm_cotation_journaliere (
            id BIGSERIAL PRIMARY KEY,
            date DATE NOT NULL, ticker TEXT NOT NULL,
            compagnie TEXT, secteur TEXT,
            cours_precedent NUMERIC, cours_ouv NUMERIC, cours_cloture NUMERIC,
            variation_jour NUMERIC, volume BIGINT, valeur_transigee BIGINT,
            cours_reference NUMERIC, variation_ytd NUMERIC,
            dernier_div NUMERIC, date_div TEXT, rendement_net NUMERIC, per NUMERIC,
            created_at TIMESTAMPTZ DEFAULT NOW(),
            UNIQUE (date, ticker)
          );
          CREATE INDEX IF NOT EXISTS idx_cj ON brvm_cotation_journaliere (ticker, date DESC);
          ALTER TABLE brvm_cotation_journaliere ENABLE ROW LEVEL SECURITY;
          DO $$ BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename='brvm_cotation_journaliere' AND policyname='read')
            THEN CREATE POLICY "read" ON brvm_cotation_journaliere FOR SELECT TO anon USING (true);
            END IF;
          END $$;
          SELECT 'SUCCESS' as result;
          """

          conn = None
          for cfg in configs:
              print(f"Trying {cfg['host']}:{cfg['port']} user={cfg['user']}...", flush=True)
              for ssl in ["require", "prefer", "disable"]:
                  try:
                      conn = psycopg2.connect(
                          host=cfg["host"], port=cfg["port"],
                          user=cfg["user"], password=password,
                          dbname="postgres", sslmode=ssl, connect_timeout=12
                      )
                      print(f"✅ Connected! (ssl={ssl})")
                      break
                  except Exception as e:
                      err = str(e).split('\n')[0][:100]
                      print(f"  ssl={ssl}: {err}")
              if conn:
                  break

          if not conn:
              print("ERROR: All connection attempts failed")
              sys.exit(1)

          cur = conn.cursor()
          cur.execute(SQL)
          conn.commit()
          print("✅ Table created successfully!")
          conn.close()
          PYEOF
