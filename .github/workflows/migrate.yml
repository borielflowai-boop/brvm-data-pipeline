name: Create Supabase Table (run once)

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Install psycopg2
        run: pip install psycopg2-binary

      - name: Create table via Python
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          python3 << 'PYEOF'
          import psycopg2, os, sys

          password = os.environ["DB_PASSWORD"]
          ref = "lfftggyzaesvgszdycbi"

          SQL = """
          CREATE TABLE IF NOT EXISTS brvm_cotation_journaliere (
            id BIGSERIAL PRIMARY KEY,
            date DATE NOT NULL,
            ticker TEXT NOT NULL,
            compagnie TEXT, secteur TEXT,
            cours_precedent NUMERIC, cours_ouv NUMERIC, cours_cloture NUMERIC,
            variation_jour NUMERIC, volume BIGINT, valeur_transigee BIGINT,
            cours_reference NUMERIC, variation_ytd NUMERIC,
            dernier_div NUMERIC, date_div TEXT, rendement_net NUMERIC, per NUMERIC,
            created_at TIMESTAMPTZ DEFAULT NOW(),
            UNIQUE (date, ticker)
          );
          CREATE INDEX IF NOT EXISTS idx_cj ON brvm_cotation_journaliere (ticker, date DESC);
          ALTER TABLE brvm_cotation_journaliere ENABLE ROW LEVEL SECURITY;
          """

          POLICY_SQL = """
          DO $$ BEGIN
            IF NOT EXISTS (
              SELECT 1 FROM pg_policies
              WHERE tablename = 'brvm_cotation_journaliere' AND policyname = 'read'
            ) THEN
              CREATE POLICY "read" ON brvm_cotation_journaliere FOR SELECT TO anon USING (true);
            END IF;
          END $$;
          """

          regions = [
            "eu-west-1", "eu-west-2", "eu-central-1",
            "us-east-1", "us-west-1", "us-east-2",
            "ap-southeast-1", "ap-northeast-1", "sa-east-1"
          ]

          conn = None
          for region in regions:
              host = f"aws-0-{region}.pooler.supabase.com"
              print(f"Trying {region}...", flush=True)
              try:
                  conn = psycopg2.connect(
                      host=host, port=6543,
                      user=f"postgres.{ref}",
                      password=password,
                      dbname="postgres",
                      sslmode="require",
                      connect_timeout=8
                  )
                  print(f"✅ Connected via {region}")
                  break
              except Exception as e:
                  print(f"  ❌ {str(e)[:80]}")

          if not conn:
              print("ERROR: Could not connect to any Supabase pooler region")
              sys.exit(1)

          cur = conn.cursor()
          cur.execute(SQL)
          cur.execute(POLICY_SQL)
          conn.commit()

          cur.execute("SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'brvm_cotation_journaliere'")
          count = cur.fetchone()[0]

          if count:
              print("✅ Table brvm_cotation_journaliere created successfully!")
          else:
              print("❌ Table creation failed")
              sys.exit(1)

          conn.close()
          PYEOF
