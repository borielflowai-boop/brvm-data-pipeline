name: Create Supabase Table (run once)

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Install psycopg2
        run: pip install psycopg2-binary

      - name: Create table via Python (IPv4 forced)
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          python3 << 'PYEOF'
          import psycopg2, os, sys, socket

          password = os.environ["DB_PASSWORD"]
          ref = "lfftggyzaesvgszdycbi"
          db_host = f"db.{ref}.supabase.co"

          # Resolve hostname — prefer IPv4 (AF_INET)
          print(f"Resolving {db_host}...", flush=True)
          try:
              results = socket.getaddrinfo(db_host, 5432, socket.AF_INET, socket.SOCK_STREAM)
              ipv4 = results[0][4][0]
              print(f"  IPv4: {ipv4}")
          except Exception as e:
              print(f"  DNS failed: {e}")
              sys.exit(1)

          SQL = """
          CREATE TABLE IF NOT EXISTS brvm_cotation_journaliere (
            id BIGSERIAL PRIMARY KEY,
            date DATE NOT NULL,
            ticker TEXT NOT NULL,
            compagnie TEXT, secteur TEXT,
            cours_precedent NUMERIC, cours_ouv NUMERIC, cours_cloture NUMERIC,
            variation_jour NUMERIC, volume BIGINT, valeur_transigee BIGINT,
            cours_reference NUMERIC, variation_ytd NUMERIC,
            dernier_div NUMERIC, date_div TEXT, rendement_net NUMERIC, per NUMERIC,
            created_at TIMESTAMPTZ DEFAULT NOW(),
            UNIQUE (date, ticker)
          );
          CREATE INDEX IF NOT EXISTS idx_cj ON brvm_cotation_journaliere (ticker, date DESC);
          ALTER TABLE brvm_cotation_journaliere ENABLE ROW LEVEL SECURITY;
          """
          POLICY_SQL = """
          DO $$ BEGIN
            IF NOT EXISTS (
              SELECT 1 FROM pg_policies WHERE tablename='brvm_cotation_journaliere' AND policyname='read'
            ) THEN
              CREATE POLICY "read" ON brvm_cotation_journaliere FOR SELECT TO anon USING (true);
            END IF;
          END $$;
          """

          print(f"Connecting to {ipv4}:5432...", flush=True)
          try:
              conn = psycopg2.connect(
                  host=ipv4, port=5432,
                  user="postgres",
                  password=password,
                  dbname="postgres",
                  sslmode="require",
                  connect_timeout=15
              )
              print("✅ Connected!")
          except Exception as e:
              print(f"❌ Connection failed: {e}")
              sys.exit(1)

          cur = conn.cursor()
          cur.execute(SQL)
          cur.execute(POLICY_SQL)
          conn.commit()
          print("✅ Table brvm_cotation_journaliere created successfully!")
          conn.close()
          PYEOF
