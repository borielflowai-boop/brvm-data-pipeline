name: Create Supabase Table (run once)

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Install psycopg2
        run: pip install psycopg2-binary

      - name: Create table via Python
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          python3 << 'PYEOF'
          import psycopg2, os, sys

          password = os.environ["DB_PASSWORD"]
          ref = "lfftggyzaesvgszdycbi"

          SQL = """
          CREATE TABLE IF NOT EXISTS brvm_cotation_journaliere (
            id BIGSERIAL PRIMARY KEY,
            date DATE NOT NULL,
            ticker TEXT NOT NULL,
            compagnie TEXT, secteur TEXT,
            cours_precedent NUMERIC, cours_ouv NUMERIC, cours_cloture NUMERIC,
            variation_jour NUMERIC, volume BIGINT, valeur_transigee BIGINT,
            cours_reference NUMERIC, variation_ytd NUMERIC,
            dernier_div NUMERIC, date_div TEXT, rendement_net NUMERIC, per NUMERIC,
            created_at TIMESTAMPTZ DEFAULT NOW(),
            UNIQUE (date, ticker)
          );
          CREATE INDEX IF NOT EXISTS idx_cj ON brvm_cotation_journaliere (ticker, date DESC);
          ALTER TABLE brvm_cotation_journaliere ENABLE ROW LEVEL SECURITY;
          """

          POLICY_SQL = """
          DO $$ BEGIN
            IF NOT EXISTS (
              SELECT 1 FROM pg_policies
              WHERE tablename = 'brvm_cotation_journaliere' AND policyname = 'read'
            ) THEN
              CREATE POLICY "read" ON brvm_cotation_journaliere FOR SELECT TO anon USING (true);
            END IF;
          END $$;
          """

          # Try all connection options
          configs = [
            # Direct connection (older Supabase projects)
            {"host": f"db.{ref}.supabase.co",                               "port": 5432, "user": "postgres"},
            # Pooler session mode port 5432
            {"host": f"aws-0-eu-west-1.pooler.supabase.com",               "port": 5432, "user": f"postgres.{ref}"},
            {"host": f"aws-0-eu-central-1.pooler.supabase.com",            "port": 5432, "user": f"postgres.{ref}"},
            {"host": f"aws-0-us-east-1.pooler.supabase.com",               "port": 5432, "user": f"postgres.{ref}"},
            {"host": f"aws-0-ap-southeast-1.pooler.supabase.com",          "port": 5432, "user": f"postgres.{ref}"},
            # Pooler transaction mode port 6543
            {"host": f"aws-0-eu-west-1.pooler.supabase.com",               "port": 6543, "user": f"postgres.{ref}"},
            {"host": f"aws-0-eu-central-1.pooler.supabase.com",            "port": 6543, "user": f"postgres.{ref}"},
            {"host": f"aws-0-us-east-1.pooler.supabase.com",               "port": 6543, "user": f"postgres.{ref}"},
          ]

          conn = None
          for cfg in configs:
              print(f"Trying {cfg['host']}:{cfg['port']} user={cfg['user']}...", flush=True)
              try:
                  conn = psycopg2.connect(
                      host=cfg["host"], port=cfg["port"],
                      user=cfg["user"],
                      password=password,
                      dbname="postgres",
                      sslmode="require",
                      connect_timeout=10
                  )
                  print(f"✅ Connected!")
                  break
              except Exception as e:
                  print(f"  ❌ {e}")

          if not conn:
              print("ERROR: Could not connect to Supabase")
              sys.exit(1)

          cur = conn.cursor()
          cur.execute(SQL)
          cur.execute(POLICY_SQL)
          conn.commit()
          print("✅ Table brvm_cotation_journaliere created successfully!")
          conn.close()
          PYEOF
